import{u as X,X as Z,d as K,r as a,Y as Q,Z as ee,j as e,p as g,T as se,_ as te,J as ae}from"./index-C4aqFuzc.js";const le={enviado:"Tu entrega ya fue registrada y está en revisión.",calificado:"Ya tiene calificación del docente.",pendiente:"Por enviar o en espera de comentario."},re=c=>{switch(c){case"calificado":return"bg-iuca-green-100 text-iuca-green-700";case"pendiente":return"bg-orange-100 text-orange-700";default:return"bg-blue-100 text-blue-700"}},ne=()=>{var F,z;const{user:c}=X(),{tasks:d,loading:R,submit:G}=Z(),{showToast:m}=K(),[b,j]=a.useState(""),[x,V]=a.useState(null),[h,k]=a.useState("all"),[f,q]=a.useState(""),[D,B]=a.useState([]),[T,A]=a.useState([]),[l,M]=a.useState(null),[E,N]=a.useState([]),[$,v]=a.useState({}),[O,P]=a.useState(""),[_,U]=a.useState(""),[n,I]=a.useState(null);a.useEffect(()=>{Q().then(B)},[]),a.useEffect(()=>{if(!c){A([]);return}ee(c.id).then(s=>A(s.map(t=>t.id)))},[c]),a.useEffect(()=>{if(!c){N([]),v({});return}(async()=>{var t,o;try{const C=await ae(),u=[],r={};for(const i of C){const J=`${((t=i.modulo)==null?void 0:t.codigo)??i.id} - ${((o=i.modulo)==null?void 0:o.nombre)??"Modulo"}`,W=()=>{u.includes(i.id)||(u.push(i.id),r[i.id]=J)};if(Array.isArray(i.studentIds)&&i.studentIds.includes(c.id)){W();continue}}N(u),v(r)}catch{N([]),v({})}})()},[c]);const y=a.useMemo(()=>d.filter(s=>!(h!=="all"&&s.status!==h||f.trim()&&!s.title.toLowerCase().includes(f.toLowerCase()))),[d,h,f]),w=a.useMemo(()=>new Set([...T,...E]),[T,E]),S=a.useMemo(()=>w.size===0?[]:D.filter(t=>w.has(t.courseId)).sort((t,o)=>new Date(t.dueDate).getTime()-new Date(o.dueDate).getTime()),[D,w]),p=a.useMemo(()=>{var u;const s=d.length,t=d.filter(r=>r.status==="pendiente").length,o=d.filter(r=>r.status==="calificado").length,C=(u=d.filter(r=>typeof r.grade=="number").sort((r,i)=>new Date(i.submittedAt).getTime()-new Date(r.submittedAt).getTime())[0])==null?void 0:u.grade;return{total:s,pending:t,graded:o,lastGrade:C}},[d]),Y=async s=>{if(s.preventDefault(),!b.trim()){m("Agrega un título para la entrega","error");return}if(x&&x.type!=="application/pdf"){m("Por ahora solo se permiten archivos PDF para visualizar en línea","error");return}const t=x==null?void 0:x.name;await G(b,t,O||void 0,_||void 0,l==null?void 0:l.id,l==null?void 0:l.title,l==null?void 0:l.dueDate),m("Entrega registrada","success"),j(""),L(null),M(null)},H=a.useMemo(()=>{const s=new Map;return Object.entries($).forEach(([t,o])=>s.set(t,o)),s},[$]),L=s=>{if(V(s),!s){P(""),U("");return}const t=new FileReader;t.onload=()=>{P(typeof t.result=="string"?t.result:""),U(s.type||"application/pdf")},t.readAsDataURL(s)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("header",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Ciencias Ambientales · Estudiantes"}),e.jsx("h1",{className:"text-3xl font-bold text-slate-800",children:"Tareas, entregas y retroalimentación"}),e.jsx("p",{className:"text-slate-600 mt-1",children:"Lleva un control claro de tus proyectos: visualiza las tareas que publica tu docente, adjunta archivos y sigue el estado."})]}),e.jsxs("section",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("article",{className:`${g} space-y-2`,children:[e.jsx("p",{className:"text-xs uppercase text-slate-400 tracking-wide",children:"Entregas totales"}),e.jsx("p",{className:"text-2xl font-semibold text-slate-800",children:p.total}),e.jsx("p",{className:"text-sm text-slate-500",children:"Organizadas por fecha y estado"})]}),e.jsxs("article",{className:`${g} space-y-2`,children:[e.jsx("p",{className:"text-xs uppercase text-slate-400 tracking-wide",children:"Pendientes"}),e.jsx("p",{className:"text-2xl font-semibold text-orange-500",children:p.pending}),e.jsx("p",{className:"text-sm text-slate-500",children:"Por enviar o corregir"})]}),e.jsxs("article",{className:`${g} space-y-2`,children:[e.jsx("p",{className:"text-xs uppercase text-slate-400 tracking-wide",children:"Calificadas"}),e.jsx("p",{className:"text-2xl font-semibold text-iuca-green-600",children:p.graded}),e.jsx("p",{className:"text-sm text-slate-500",children:"Con comentarios docentes"})]}),e.jsxs("article",{className:`${g} space-y-1`,children:[e.jsx("p",{className:"text-xs uppercase text-slate-400 tracking-wide",children:"Última nota"}),e.jsx("p",{className:"text-2xl font-semibold text-slate-800",children:p.lastGrade??"--"}),e.jsx("p",{className:"text-sm text-slate-500",children:p.lastGrade?"Basado en la entrega más reciente":"Sin calificaciones aún"})]})]}),e.jsxs("section",{className:"bg-white border border-slate-100 rounded-2xl shadow-sm p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-3 items-center justify-between",children:[e.jsx("div",{className:"flex gap-2 text-sm",children:["all","enviado","calificado","pendiente"].map(s=>e.jsx("button",{type:"button",onClick:()=>k(s),className:`px-3 py-1.5 rounded-full text-xs font-semibold transition ${h===s?"bg-iuca-blue-600 text-white shadow":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:s==="all"?"Todos":s.charAt(0).toUpperCase()+s.slice(1)},s))}),e.jsx("input",{type:"search",value:f,onChange:s=>q(s.target.value),placeholder:"Buscar por título...",className:"text-sm border border-slate-200 rounded-full px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-iuca-blue-500"})]}),e.jsxs("form",{onSubmit:Y,className:"grid md:grid-cols-[3fr_2fr] gap-3",children:[e.jsxs("div",{className:"border border-slate-200 rounded-xl px-4 py-3 space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-slate-600",children:"Título de la entrega"}),e.jsx("input",{value:b,onChange:s=>j(s.target.value),className:"w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-iuca-blue-500",placeholder:"Ej. Informe de laboratorio #4",required:!0}),l&&e.jsxs("p",{className:"text-xs text-slate-500",children:["Dirigido a: ",l.title," · vence ",new Date(l.dueDate).toLocaleDateString()]})]}),e.jsxs("div",{className:"border border-slate-200 rounded-xl px-4 py-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{htmlFor:"task-file",className:"text-sm font-medium text-slate-600",children:"Adjuntar archivo"}),x&&e.jsx("span",{className:"text-xs text-slate-400",children:x.name})]}),e.jsx("input",{id:"task-file",type:"file",accept:"application/pdf",onChange:s=>{var t;return L(((t=s.target.files)==null?void 0:t[0])??null)},className:"block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-iuca-green-600 file:text-white hover:file:bg-iuca-green-700"})]}),e.jsx("button",{type:"submit",className:`${se} ${te} md:col-span-2 py-3`,children:"Enviar entrega"})]})]}),e.jsxs("section",{className:"grid lg:grid-cols-2 gap-6",children:[e.jsxs("article",{className:"bg-white border border-slate-100 rounded-2xl shadow-sm p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold text-slate-800",children:"Tareas publicadas por tus docentes"}),e.jsxs("p",{className:"text-xs text-slate-400",children:[S.length," disponibles"]})]}),S.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"Aún no hay tareas nuevas para tus cursos. Revisa comunicados o habla con tus docentes."}):e.jsx("ul",{className:"space-y-3",children:S.map(s=>{const t=H.get(s.courseId);return e.jsxs("li",{className:"border border-slate-100 rounded-2xl p-4 shadow-sm flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-slate-800",children:s.title}),e.jsxs("p",{className:"text-sm text-slate-500",children:[t?`${t}`:"Curso general"," · vence"," ",new Date(s.dueDate).toLocaleDateString()]}),s.description&&e.jsx("p",{className:"text-xs text-slate-400 mt-1",children:s.description})]}),e.jsx("button",{type:"button",onClick:()=>{M(s),j(s.title),m(`Preparando entrega para ${s.title}`,"info")},className:"text-sm font-semibold text-iuca-blue-600 hover:text-iuca-blue-500",children:"Enviar ahora"})]},s.id)})})]}),e.jsxs("article",{className:"bg-white border border-slate-100 rounded-2xl shadow-sm p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold text-slate-800",children:"Historial de entregas"}),e.jsxs("p",{className:"text-xs text-slate-400",children:["Últimos ",y.length," registros"]})]}),R?e.jsx("p",{className:"text-sm text-slate-500",children:"Cargando tareas…"}):y.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"Aún no has entregado tareas."}):e.jsx("ul",{className:"space-y-3",children:y.map(s=>e.jsxs("li",{className:"border border-slate-100 rounded-2xl p-4 shadow-sm flex flex-col md:flex-row md:items-center gap-4 justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-lg font-semibold text-slate-800",children:s.title}),e.jsxs("p",{className:"text-sm text-slate-500",children:[new Date(s.submittedAt).toLocaleString()," · ",s.fileName||"Sin archivo"]}),s.assignmentTitle&&e.jsxs("p",{className:"text-xs text-slate-400 mt-1",children:["Asignación: ",s.assignmentTitle," ",s.assignmentDue?`· vence ${new Date(s.assignmentDue).toLocaleDateString()}`:""]}),e.jsx("p",{className:"text-xs text-slate-400 mt-1",children:le[s.status]})]}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("span",{className:`text-xs font-semibold px-3 py-1 rounded-full ${re(s.status)}`,children:s.status.charAt(0).toUpperCase()+s.status.slice(1)}),typeof s.grade=="number"&&e.jsxs("span",{className:"text-sm font-semibold text-slate-700 bg-slate-100 px-3 py-1 rounded-full",children:[s.grade,"/10"]}),s.fileUrl&&e.jsx("button",{type:"button",className:"text-xs text-iuca-blue-600 font-semibold hover:underline",onClick:()=>I(s),children:"Ver archivo"}),e.jsx("button",{type:"button",className:"text-xs text-iuca-blue-600 font-semibold hover:underline",onClick:()=>m("Pronto podrás consultar retroalimentación extendida.","info"),children:"Ver comentarios"})]})]},s.id))})]})]}),n&&e.jsx("div",{className:"fixed inset-0 z-40 flex items-center justify-center bg-slate-900/70 px-4",children:e.jsxs("div",{className:"w-full max-w-4xl rounded-2xl bg-white shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-slate-200 px-6 py-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-slate-400",children:"Vista rápida"}),e.jsx("h3",{className:"text-lg font-semibold text-slate-800",children:n.fileName??"Archivo adjunto"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[n.fileUrl&&e.jsx("a",{href:n.fileUrl,download:n.fileName||"archivo.pdf",className:"rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-50",children:"Descargar"}),e.jsx("button",{onClick:()=>I(null),className:"rounded-full bg-slate-900 px-3 py-2 text-xs font-semibold text-white hover:bg-slate-700",children:"Cerrar"})]})]}),e.jsx("div",{className:"max-h-[75vh] overflow-auto px-6 py-4",children:n.fileUrl?(F=n.fileMime)!=null&&F.includes("pdf")||(z=n.fileName)!=null&&z.toLowerCase().endsWith(".pdf")?e.jsx("iframe",{title:"Vista previa del archivo",src:n.fileUrl,className:"h-[70vh] w-full rounded-lg border border-slate-200"}):e.jsx("p",{className:"text-sm text-slate-600",children:"Este tipo de archivo no se puede visualizar aquí. Usa el botón Descargar para abrirlo localmente."}):e.jsx("p",{className:"text-sm text-slate-600",children:"Este envío no cuenta con archivo adjunto."})})]})})]})};export{ne as default};
