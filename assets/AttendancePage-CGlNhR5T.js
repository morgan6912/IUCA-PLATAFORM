import{u as G,d as W,e as r,j as s,J as Z}from"./index-C4aqFuzc.js";import{s as ee,a as se,g as w,r as te,l as ae,b as le,c as re,d as ne,e as de,f as P}from"./teacherService-BvBxNJ2F.js";const B=["L","M","X","J","V","S"],ce={L:"Lunes",M:"Martes",X:"Miércoles",J:"Jueves",V:"Viernes",S:"Sábado"},xe=()=>{const{user:u}=G(),{showToast:A}=W(),[F,S]=r.useState(!0),[p,C]=r.useState([]),[a,j]=r.useState(""),[f,H]=r.useState([]),[b,N]=r.useState([]),[x,v]=r.useState({}),[o,M]=r.useState(new Date().toISOString().slice(0,10)),[k,E]=r.useState({}),[R,I]=r.useState([]),[y,J]=r.useState("all"),[L,V]=r.useState({});r.useEffect(()=>{(async()=>{if(!u)return;S(!0);const t=await ae();H(t);try{const n=await Z(),c=l=>u?l.profesorId===u.id?!0:!l.profesorNombre||!u.name?!1:l.profesorNombre.trim().toLowerCase()===u.name.trim().toLowerCase():!1,i=n.filter(c).map(l=>({id:l.id,profesorId:l.profesorId,profesorNombre:l.profesorNombre,modulo:l.modulo,studentIds:Array.isArray(l.studentIds)?l.studentIds:[]}));C(i),j(l=>{var h;return l&&i.some(m=>m.id===l)?l:((h=i[0])==null?void 0:h.id)??""})}catch{C([]),j("")}S(!1)})()},[u]),r.useEffect(()=>{(async()=>{if(!a)return;const t=await w(a);N(t);const n=await le(a,o);v(n);const c=await re(a,o);E(c);const i=await ne(a);I(i);const l=await de(a);V(l)})()},[a,o]);const d=r.useMemo(()=>f.filter(e=>b.includes(e.id)),[f,b]),_=r.useMemo(()=>f.filter(e=>!b.includes(e.id)),[f,b]),D=r.useMemo(()=>{switch(y){case"present":return d.filter(e=>x[e.id]);case"absent":return d.filter(e=>!x[e.id]);default:return d}},[y,d,x]),U=r.useMemo(()=>d.filter(e=>x[e.id]).length,[d,x]),X=d.length?Math.round(U/d.length*100):0,Y=r.useMemo(()=>{const e={};return Object.entries(L).forEach(([t,n])=>{Object.entries(n).forEach(([c,i])=>{e[c]||(e[c]={present:0,absent:0,total:0}),e[c].total+=1,i?e[c].present+=1:e[c].absent+=1})}),e},[L]),T=r.useMemo(()=>{const e=p.find(t=>t.id===a);return e?e.modulo.codigo:""},[a,p]),g=async e=>{if(!a||d.length===0)return;const t={...x};await Promise.all(d.map(async n=>{await P(a,o,n.id,e),t[n.id]=e})),v(t)},$=r.useMemo(()=>{const e=[];return p.forEach(t=>{t.modulo.materias.forEach(n=>{Object.entries(n.horario).forEach(([c,i])=>{const l=c.slice(0,1).toUpperCase(),h=i;e.push({courseId:t.id,title:n.nombre,code:`${t.modulo.codigo}-${n.clave}`,days:[l],time:h,room:void 0})})})}),e},[p]),O=r.useMemo(()=>{const e={};return B.forEach(t=>{e[t]=[]}),$.forEach(t=>{t.days.forEach(n=>{const c=n.toUpperCase();e[c]||(e[c]=[]),e[c].push(t)})}),e},[$]),q=async(e,t)=>{if(!a)return;const n={...x,[e]:t};v(n),await P(a,o,e,t)},z=r.useCallback(async(e,t)=>{a&&(await ee(a,o,e,t),E(n=>({...n,[e]:t})))},[a,o]),K=()=>{const e=["studentId","name","email","present","date"],t=d.map(m=>[m.id,m.name,m.email,x[m.id]?"1":"0",o]),n=[e,...t].map(m=>m.map(Q=>'"'+String(Q).replace('"','""')+'"').join(",")).join(`
`),c=new Blob([n],{type:"text/csv;charset=utf-8"}),i=URL.createObjectURL(c),l=document.createElement("a");l.href=i;const h=T||"curso";l.download=`asistencia_${h}_${o}.csv`,l.click(),URL.revokeObjectURL(i)};return F?s.jsx("div",{children:"Cargando asistencia..."}):s.jsxs("div",{className:"space-y-6",children:[s.jsx("h1",{className:"text-3xl font-bold text-slate-800",children:"Control de Asistencia"}),s.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-md space-y-4",children:[s.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-xs uppercase tracking-wide text-slate-400",children:"Asistencia del día"}),s.jsxs("p",{className:"text-2xl font-semibold text-slate-800",children:[U,"/",d.length," (",X,"%)"]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:()=>g(!0),className:"px-3 py-2 bg-iuca-green-600 text-white rounded-md text-xs font-semibold hover:bg-iuca-green-700",children:"Marcar todos presentes"}),s.jsx("button",{onClick:()=>g(!1),className:"px-3 py-2 bg-slate-50 text-slate-700 rounded-md text-xs font-semibold border border-slate-200 hover:bg-slate-100",children:"Marcar todos ausentes"})]})]}),s.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[s.jsxs("select",{value:a,onChange:e=>j(e.target.value),className:"border border-slate-300 rounded-md p-2",children:[s.jsx("option",{value:"",children:"Selecciona módulo"}),p.map(e=>s.jsxs("option",{value:e.id,children:[e.modulo.codigo," - ",e.modulo.nombre]},e.id))]}),a&&s.jsxs(s.Fragment,{children:[s.jsx("input",{type:"date",value:o,onChange:e=>M(e.target.value),className:"border border-slate-300 rounded-md p-2"}),s.jsx("button",{type:"button",onClick:K,className:"px-3 py-2 rounded-md bg-iuca-green-600 text-white hover:bg-iuca-green-700",children:"Exportar CSV"})]})]}),s.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-md",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Horario de clases"}),s.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:B.map(e=>s.jsxs("div",{className:"border border-slate-100 rounded-2xl p-3 bg-slate-50",children:[s.jsx("h3",{className:"text-sm font-semibold text-slate-600 mb-2",children:ce[e]}),O[e].length===0?s.jsx("p",{className:"text-xs text-slate-500",children:"Sin clases programadas"}):O[e].map(t=>s.jsxs("div",{className:"mb-2",children:[s.jsx("p",{className:"text-sm font-semibold text-slate-800",children:t.code}),s.jsx("p",{className:"text-xs text-slate-500",children:t.time}),s.jsx("p",{className:"text-xs text-slate-500",children:t.title}),t.room&&s.jsxs("p",{className:"text-[11px] text-slate-400",children:["Aula ",t.room]})]},`${t.courseId}-${e}`))]},e))})]})]}),a&&s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[s.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-md space-y-3",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Lista de estudiantes"}),s.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[s.jsxs("select",{className:"border border-slate-300 rounded-md p-2 flex-1",onChange:async e=>{const t=e.target.value;t&&(await se(a,t),N(await w(a)),A("Estudiante agregado","success"),e.currentTarget.value="")},children:[s.jsx("option",{value:"",children:"Agregar estudiante..."}),_.map(e=>s.jsxs("option",{value:e.id,children:[e.name," · ",e.email]},e.id))]}),s.jsxs("span",{className:"text-xs text-slate-500",children:[d.length," inscritos"]})]}),s.jsxs("div",{className:"divide-y",children:[d.map(e=>s.jsxs("div",{className:"py-2 flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("img",{src:e.avatarUrl,alt:e.name,className:"w-8 h-8 rounded-full"}),s.jsxs("div",{children:[s.jsx("div",{className:"text-slate-800 font-medium",children:e.name}),s.jsx("div",{className:"text-slate-500 text-xs",children:e.email})]})]}),s.jsx("button",{className:"text-sm text-red-600 hover:underline",onClick:async()=>{await te(a,e.id),N(await w(a)),A("Estudiante removido","info")},children:"Quitar"})]},e.id)),d.length===0&&s.jsx("p",{className:"text-slate-500 text-sm py-2",children:"Sin estudiantes aún."})]})]}),s.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-md space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h2",{className:"text-lg font-semibold mb-1",children:"Asistencia"}),s.jsxs("p",{className:"text-xs text-slate-500",children:[o," · ",T||"sin seleccion"]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:()=>g(!0),className:"px-3 py-2 bg-iuca-green-600 text-white rounded-md text-xs font-semibold hover:bg-iuca-green-700",children:"Marcar todos presentes"}),s.jsx("button",{onClick:()=>g(!1),className:"px-3 py-2 bg-slate-50 text-slate-700 rounded-md text-xs font-semibold border border-slate-200 hover:bg-slate-100",children:"Marcar todos ausentes"})]})]}),s.jsx("div",{className:"flex flex-wrap gap-2",children:["all","present","absent"].map(e=>s.jsx("button",{type:"button",onClick:()=>J(e),className:`px-3 py-1 rounded-full text-xs font-semibold border ${y===e?"border-emerald-500 bg-emerald-50 text-emerald-700":"border-slate-200 bg-white text-slate-600"}`,children:e==="present"?"Presentes":e==="absent"?"Ausentes":"Todos"},e))}),R.length>0&&s.jsx("div",{className:"flex flex-wrap gap-2",children:R.map(e=>s.jsx("button",{type:"button",onClick:()=>M(e),className:`px-3 py-1 rounded-full text-xs border ${o===e?"border-emerald-500 bg-emerald-50 text-emerald-700":"border-slate-200 bg-white text-slate-600"}`,children:e},e))}),s.jsx("ul",{className:"divide-y",children:D.map(e=>s.jsxs("li",{className:"py-3 flex flex-col gap-2 border-b border-slate-100",children:[s.jsxs("div",{className:"flex items-center justify-between gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("img",{src:e.avatarUrl,alt:e.name,className:"w-8 h-8 rounded-full"}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-semibold text-slate-800",children:e.name}),s.jsx("p",{className:"text-xs text-slate-500",children:e.email})]})]}),s.jsxs("label",{className:"flex items-center gap-2 text-xs",children:[s.jsx("input",{type:"checkbox",checked:!!x[e.id],onChange:t=>q(e.id,t.target.checked)}),"Presente"]})]}),s.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[s.jsx("input",{type:"text",placeholder:"Nota (permiso, retardo, observación)",value:k[e.id]||"",onChange:t=>z(e.id,t.target.value),className:"flex-1 border border-slate-200 rounded-full px-3 py-1 text-xs focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-200"}),k[e.id]&&s.jsx("span",{className:"text-[11px] text-emerald-600",children:"Nota guardada"})]})]},e.id))}),D.length===0&&s.jsx("p",{className:"text-slate-500 text-sm",children:"No hay estudiantes que coincidan con ese filtro."})]}),s.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-md space-y-3",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Histórico de asistencias"}),s.jsx("p",{className:"text-xs text-slate-500",children:"Resumen de presentes/ausentes por alumno en este módulo."}),s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"min-w-full divide-y divide-slate-100 text-sm",children:[s.jsx("thead",{className:"bg-slate-50 text-xs uppercase tracking-wider text-slate-500",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-2 py-2 text-left",children:"Alumno"}),s.jsx("th",{className:"px-2 py-2 text-left",children:"Presentes"}),s.jsx("th",{className:"px-2 py-2 text-left",children:"Ausentes"}),s.jsx("th",{className:"px-2 py-2 text-left",children:"Total"})]})}),s.jsxs("tbody",{className:"divide-y divide-slate-100",children:[d.map(e=>{const t=Y[e.id]||{present:0,absent:0,total:0};return s.jsxs("tr",{children:[s.jsxs("td",{className:"px-2 py-2",children:[s.jsx("div",{className:"font-semibold text-slate-800",children:e.name}),s.jsx("div",{className:"text-xs text-slate-500",children:e.email})]}),s.jsx("td",{className:"px-2 py-2 text-emerald-700 font-semibold",children:t.present}),s.jsx("td",{className:"px-2 py-2 text-rose-600 font-semibold",children:t.absent}),s.jsx("td",{className:"px-2 py-2 text-slate-700",children:t.total})]},e.id)}),d.length===0&&s.jsx("tr",{children:s.jsx("td",{colSpan:4,className:"px-2 py-3 text-sm text-slate-500",children:"Sin estudiantes en este módulo."})})]})]})})]})]})]})};export{xe as default};
