import{z as k,u as V,r as x,A as Y,e as o,d as Q,B as W,R as b,j as t}from"./index-C4aqFuzc.js";const $="iuca-chat-general",P="http://localhost:4000",B=async(s,m=200)=>new Promise(n=>setTimeout(()=>n(s),m)),F=()=>{try{const s=localStorage.getItem($);return s?JSON.parse(s):k}catch{return k}},X=s=>{localStorage.setItem($,JSON.stringify(s))},z=s=>({id:s.id??Date.now(),userId:s.user_id,userName:s.user_name,avatarUrl:s.avatar_url||"",text:s.text,timestamp:s.created_at?new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",attachmentUrl:s.attachment_url||void 0,attachmentName:s.attachment_name||void 0,toUserId:s.to_user_id||void 0,toUserName:s.to_user_name||void 0}),Z=async()=>{try{const s=await fetch(`${P}/communication/messages`,{credentials:"include"});if(!s.ok)throw new Error("Error remoto");return(await s.json()).map(z)}catch(s){console.error("Fallo obteniendo mensajes de API, uso local",s)}return B(F())},ee=async(s,m,n,i,l)=>{var h;try{const p={userId:s.id,userName:s.name,avatarUrl:s.avatarUrl,text:m.trim(),attachmentUrl:(n==null?void 0:n.trim())||void 0,attachmentName:(i==null?void 0:i.trim())||void 0,toUserId:l==null?void 0:l.userId,toUserName:l==null?void 0:l.userName},j=await fetch(`${P}/communication/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p),credentials:"include"});if(!j.ok)throw new Error("Error remoto");const y=await j.json();return z(y)}catch(p){console.error("Fallo enviando mensaje a API, uso local",p)}const d=F(),c={id:(((h=d[d.length-1])==null?void 0:h.id)??0)+1,userId:s.id,userName:s.name,avatarUrl:s.avatarUrl,text:m.trim(),timestamp:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),attachmentUrl:(n==null?void 0:n.trim())||void 0,attachmentName:(i==null?void 0:i.trim())||void 0,toUserId:l==null?void 0:l.userId,toUserName:l==null?void 0:l.userName},N=[...d,c];return X(N),B(c)},te=()=>{const{user:s}=V(),[m,n]=x.useState([]),[i,l]=x.useState(!0),d=x.useCallback(async()=>{l(!0);const c=await Z();n(c),l(!1)},[]);x.useEffect(()=>{d()},[d]);const w=x.useCallback(async(c,N,h,p)=>{if(!s||!c.trim())return;const j=await ee(s,c,N,h,p);n(y=>[...y,j])},[s]);return{messages:m,loading:i,send:w}},re=()=>{const{messages:s,send:m}=te(),{items:n}=Y(),[i,l]=o.useState(""),[d,w]=o.useState(""),[c,N]=o.useState(""),[h,p]=o.useState([]),[j,y]=o.useState(!1),[S,U]=o.useState(""),[I,E]=o.useState(""),[C,H]=o.useState(""),[g,A]=o.useState("general"),{showToast:M}=Q(),{user:u}=V(),R=x.useRef(null),D=x.useRef(null),[se,J]=o.useState(!1);x.useEffect(()=>{var e;(e=R.current)==null||e.scrollIntoView({behavior:"smooth"})},[s]),x.useEffect(()=>{W().then(e=>{const a=e.filter(r=>r.role===b.DOCENTE||r.role===b.ADMINISTRATIVO||r.role===b.DIRECTIVO).map(r=>({id:r.id,name:r.name,role:r.role}));p(a)})},[]),x.useEffect(()=>{const e=D.current;if(!e)return;const a=()=>{const r=e.scrollHeight-e.scrollTop-e.clientHeight<120;J(!r)};return e.addEventListener("scroll",a),a(),()=>e.removeEventListener("scroll",a)},[]);const G=e=>{var _,O;if(e.preventDefault(),i.trim()===""||!u)return;const a=((_=document.querySelector("input[name=attachment]"))==null?void 0:_.value)||"",r=I||a||void 0,f=I?S||"Archivo":a?"Archivo":void 0,v=d?{userId:d,userName:c||((O=h.find(K=>K.id===d))==null?void 0:O.name)||""}:void 0;if(m(i,r,f,v),M("Mensaje enviado","success"),l(""),I){try{URL.revokeObjectURL(I)}catch{}E(""),U("")}},L=o.useMemo(()=>new Map(h.map(e=>[e.id,e])),[h]),q=o.useMemo(()=>s.filter(e=>{var r;if(g!=="general"){const f=e.toUserId?L.get(e.toUserId):null;if(!f||f.role!==g)return!1}if(!C.trim())return!0;const a=C.toLowerCase();return e.text.toLowerCase().includes(a)||e.userName.toLowerCase().includes(a)||(((r=e.toUserName)==null?void 0:r.toLowerCase().includes(a))??!1)}).filter(e=>j&&u?e.toUserId===u.id:!0),[s,g,C,j,L,u]),T=o.useMemo(()=>{const e=s.length,a=s.filter(v=>!!v.toUserId).length,r=e-a,f=u?s.filter(v=>v.toUserId===u.id).length:0;return{total:e,directed:a,general:r,toMe:f}},[s,u]);return t.jsxs("div",{className:"flex h-[calc(100vh-140px)] overflow-hidden rounded-2xl shadow-xl bg-white",children:[t.jsxs("aside",{className:"w-80 border-r border-slate-100 flex flex-col",children:[t.jsxs("div",{className:"px-4 py-3 border-b border-slate-100",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase text-slate-400",children:"IUCA Chat"}),t.jsx("h2",{className:"text-lg font-semibold text-slate-800",children:"Comunicación Interna"})]}),t.jsxs("div",{className:"flex flex-col items-end",children:[t.jsx("span",{className:"text-xs text-slate-500",children:"Conectados"}),t.jsx("span",{className:"text-sm font-semibold text-iuca-green-600",children:T.total})]})]}),t.jsx("div",{className:"mt-4 flex flex-wrap gap-2",children:["general",b.DOCENTE,b.ADMINISTRATIVO,b.DIRECTIVO].map(e=>t.jsx("button",{type:"button",onClick:()=>A(e),className:`px-3 py-1 rounded-full text-xs font-semibold border ${g===e?"border-iuca-blue-600 bg-iuca-blue-50 text-iuca-blue-700":"border-slate-200 bg-white text-slate-500"}`,children:e==="general"?"General":e.charAt(0).toUpperCase()+e.slice(1)},e))}),t.jsxs("div",{className:"mt-3 relative",children:[t.jsx("input",{type:"search",value:C,onChange:e=>H(e.target.value),placeholder:"Buscar mensajes...",className:"w-full rounded-full border border-slate-200 px-3 py-2 text-sm focus:border-iuca-blue-500 focus:ring-2 focus:ring-iuca-blue-200"}),t.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400",children:"Ctrl+F"})]})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto px-4 py-3 space-y-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs text-slate-500",children:"Destinatarios destacados"}),t.jsx("div",{className:"mt-2 space-y-2",children:h.map(e=>t.jsxs("button",{type:"button",onClick:()=>{w(e.id),N(e.name),A(e.role)},className:"w-full flex items-center justify-between px-3 py-2 rounded-xl bg-slate-50 hover:bg-slate-100 text-left text-sm",children:[t.jsx("span",{children:e.name}),t.jsx("span",{className:"text-xs text-slate-400",children:e.role})]},e.id))})]}),t.jsxs("div",{className:"pt-4 border-t border-slate-100",children:[t.jsx("p",{className:"text-xs text-slate-500",children:"Nuevos comunicados"}),t.jsx("ul",{className:"mt-2 space-y-2 text-sm text-slate-700 max-h-48 overflow-auto pr-2",children:n.slice(0,5).map(e=>t.jsxs("li",{className:"p-2 bg-slate-50 rounded-lg",children:[t.jsx("p",{className:"font-semibold text-slate-800",children:e.title}),t.jsx("p",{className:"text-xs text-slate-500",children:e.body})]},e.id))})]})]})]}),t.jsxs("section",{className:"flex-1 flex flex-col",children:[t.jsxs("header",{className:"px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-gradient-to-r from-iuca-green-500 to-iuca-blue-600 text-white",children:[t.jsxs("div",{children:[t.jsxs("p",{className:"text-xs uppercase tracking-wide",children:["Canal ",g==="general"?"General":g.charAt(0).toUpperCase()+g.slice(1)]}),t.jsx("h2",{className:"text-xl font-semibold",children:c?`Para ${c}`:"Todos los integrantes"})]}),t.jsxs("div",{className:"text-right text-xs",children:[t.jsxs("p",{className:"text-white/80",children:["Dirigidos: ",T.directed]}),t.jsxs("p",{className:"text-white/80",children:["Solo mí: ",T.toMe]})]})]}),t.jsxs("div",{ref:D,className:"flex-1 overflow-y-auto px-6 py-5 space-y-4 bg-slate-50",children:[q.map(e=>{const a=e.userId===(u==null?void 0:u.id);return t.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:t.jsxs("div",{className:`max-w-xl space-y-1 ${a?"text-right":"text-left"}`,children:[t.jsxs("div",{className:`inline-flex flex-col items-start gap-1 ${a?"items-end":"items-start"}`,children:[t.jsx("span",{className:`text-xs font-semibold ${a?"text-iuca-green-600":"text-slate-500"}`,children:e.userName}),t.jsx("p",{className:`px-4 py-2 rounded-2xl text-sm leading-relaxed ${a?"bg-gradient-to-br from-iuca-blue-600 to-iuca-blue-500 text-white":"bg-white text-slate-800 shadow-sm"}`,children:e.text})]}),e.attachmentUrl&&t.jsx("a",{href:e.attachmentUrl,target:"_blank",rel:"noreferrer",className:`text-xs ${a?"text-blue-100":"text-iuca-blue-600"} underline`,children:e.attachmentName||"Archivo adjunto"}),t.jsxs("div",{className:"flex items-center justify-between text-[11px] text-slate-500",children:[t.jsx("span",{children:e.timestamp}),e.toUserName&&t.jsxs("span",{children:["→ ",e.toUserName]})]})]})},e.id)}),t.jsx("div",{ref:R})]}),t.jsx("footer",{className:"px-6 py-4 border-t border-slate-100 bg-white",children:t.jsxs("form",{onSubmit:G,className:"flex items-center gap-3",children:[t.jsx("button",{type:"button",onClick:()=>{var e;return(e=document.getElementById("chat-file"))==null?void 0:e.click()},className:"p-2 rounded-full border border-slate-200 text-slate-500 hover:text-iuca-blue-600 transition",children:t.jsxs("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 24 24",children:[t.jsx("path",{d:"M16.5 9.4V3.5a2.5 2.5 0 0 0-5 0v6.9a.5.5 0 1 1-1 0V3.5a3.5 3.5 0 0 1 7 0v6.9a3.5 3.5 0 0 1-7 0V3.5a.5.5 0 0 0-1 0v6.9a4.5 4.5 0 0 0 9 0z"}),t.jsx("path",{d:"M12 11.5a5.5 5.5 0 0 0 5.5-5.5V4a.5.5 0 0 1 1 0v2a6.5 6.5 0 0 1-13 0V4a.5.5 0 0 1 1 0v2A5.5 5.5 0 0 0 12 11.5z"})]})}),t.jsx("input",{type:"file",id:"chat-file",className:"hidden",onChange:e=>{var r;const a=(r=e.target.files)==null?void 0:r[0];if(!a){U(""),E("");return}U(a.name);try{const f=URL.createObjectURL(a);E(f),M("Archivo adjuntado","info")}catch{M("No se pudo adjuntar el archivo","error")}}}),t.jsxs("div",{className:"flex-1",children:[t.jsx("input",{type:"text",value:i,onChange:e=>l(e.target.value),placeholder:"Escribe un mensaje...",className:"w-full rounded-full border border-slate-200 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-iuca-blue-500"}),S&&t.jsx("p",{className:"text-[11px] text-slate-500 mt-1",children:S})]}),t.jsx("button",{type:"submit",className:"bg-iuca-blue-600 text-white px-4 py-2 rounded-full text-sm font-semibold",children:"Enviar"})]})})]})]})};export{re as default};
